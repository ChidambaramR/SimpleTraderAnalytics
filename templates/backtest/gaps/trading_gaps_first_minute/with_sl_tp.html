{% extends "base.html" %}

{% block content %}
<div class="strategy-description">
    <h2>Trading overnight gapped stocks from open to nth minute</h2>
    <p>
        On a gap up, we short the stock at open and exit at the specified minute's open price. On a gap down, we go long at open and exit at the specified minute's open price. 
        The position will be closed earlier if stop loss or take profit is hit during any minute, or at the specified exit time.
    </p>
</div>

<div class="backtest-form mb-4">
    <form method="GET" action="{{ url_for('gaps_from_first_to_nth_minute_with_sl_tp') }}">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="from_date" class="form-label">From Date</label>
                <input type="date" class="form-control" id="from_date" name="from_date" 
                       value="{{ request.args.get('from_date', '') }}" required>
            </div>
            <div class="col-md-2">
                <label for="to_date" class="form-label">To Date</label>
                <input type="date" class="form-control" id="to_date" name="to_date" 
                       value="{{ request.args.get('to_date', '') }}" required>
            </div>
            <div class="col-md-2">
                <label for="stop_loss" class="form-label">SL %</label>
                <input type="number" class="form-control" id="stop_loss" name="stop_loss" 
                       value="{{ request.args.get('stop_loss', '0.75') }}" step="0.01" required>
            </div>
            <div class="col-md-1">
                <label for="take_profit" class="form-label">TP %</label>
                <input type="number" class="form-control" id="take_profit" name="take_profit" 
                       value="{{ request.args.get('take_profit', '2') }}" step="0.01" required>
            </div>
            <div class="col-md-2">
                <label for="exit_time" class="form-label">Exit Time (HH:MM)</label>
                <input type="text" class="form-control" id="exit_time" name="exit_time" 
                       value="{{ request.args.get('exit_time', '09:16') }}" 
                       pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]" required>
            </div>
            <div class="col-md-2">
                <label for="initial_capital" class="form-label">Initial Capital</label>
                <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="{{ request.args.get('initial_capital', '100000') }}" min="1" required>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Run Backtest</button>
            </div>
        </div>
    </form>
</div>

{% if results %}
    {% if results.error %}
    <div class="alert alert-danger" role="alert">
        {{ results.error }}
    </div>
    {% else %}
    <div class="results-section">
        <h3>Backtest Results</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Account</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Trades</td>
                    <td>{{ results.total_trades }}</td>
                </tr>
                <tr>
                    <td>Win Ratio</td>
                    <td>{{ '{:,.2f}'.format(results.win_ratio) }}%</td>
                </tr>
                <tr>
                    <td>Initial Capital</td>
                    <td>₹{{ results.initial_capital|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Capital Added</td>
                    <td>₹{{ results.capital_added|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Final Capital</td>
                    <td>₹{{ results.final_capital|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Profit</td>
                    <td>₹{{ results.profit|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Return on Investment</td>
                    <td>{{ '{:,.2f}'.format(results.roi) }}%</td>
                </tr>
                <tr>
                    <td>Max Drawdown</td>
                    <td>₹{{ results.max_drawdown|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Average Profit per Trade</td>
                    <td>₹{{ results.avg_profit_per_trade|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Average Loss per Trade</td>
                    <td>₹{{ results.avg_loss_per_trade|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Average Daily Profit</td>
                    <td>₹{{ results.avg_daily_profit|indian_currency }}</td>
                </tr>
                <tr>
                    <td>Average Daily Loss</td>
                    <td>₹{{ results.avg_daily_loss|indian_currency }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- Stock Level Statistics -->
    <div class="results-section mt-4">
        <h3>Stock Level Statistics</h3>
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="stockTable1L">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="Symbol">Symbol <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Total Trades">Total Trades <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Wins">Wins <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Win Ratio">Win Ratio <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Losses">Losses <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Loss Ratio">Loss Ratio <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Total PNL">Total PNL <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Up Trades">Gap Up Trades <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Up Wins">Gap Up Wins <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Up Losses">Gap Up Losses <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Down Trades">Gap Down Trades <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Down Wins">Gap Down Wins <span class="sort-icon">↕</span></th>
                        <th class="sortable" data-sort="Gap Down Losses">Gap Down Losses <span class="sort-icon">↕</span></th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in results.stock_stats.stocks %}
                    <tr class="stock-row-1L">
                        <td data-value="{{ stock.Symbol }}">{{ stock.Symbol }}</td>
                        <td data-value="{{ stock['Total Trades'] }}">{{ stock['Total Trades'] }}</td>
                        <td data-value="{{ stock.Wins }}">{{ stock.Wins }}</td>
                        <td data-value="{{ stock['Win Ratio'] }}">{{ '{:,.2f}'.format(stock['Win Ratio']) }}%</td>
                        <td data-value="{{ stock.Losses }}">{{ stock.Losses }}</td>
                        <td data-value="{{ stock['Loss Ratio'] }}">{{ '{:,.2f}'.format(stock['Loss Ratio']) }}%</td>
                        <td data-value="{{ stock['Total PNL'] }}" class="{{ 'text-success' if stock['Total PNL'] > 0 else 'text-danger' }}">₹{{ stock['Total PNL']|indian_currency }}</td>
                        <td data-value="{{ stock['Gap Up Trades'] }}">{{ stock['Gap Up Trades'] }}</td>
                        <td data-value="{{ stock['Gap Up Wins'] }}">{{ stock['Gap Up Wins'] }}</td>
                        <td data-value="{{ stock['Gap Up Losses'] }}">{{ stock['Gap Up Losses'] }}</td>
                        <td data-value="{{ stock['Gap Down Trades'] }}">{{ stock['Gap Down Trades'] }}</td>
                        <td data-value="{{ stock['Gap Down Wins'] }}">{{ stock['Gap Down Wins'] }}</td>
                        <td data-value="{{ stock['Gap Down Losses'] }}">{{ stock['Gap Down Losses'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <nav aria-label="Stock statistics pagination">
                <ul class="pagination justify-content-center" id="pagination1L"></ul>
            </nav>
            <div class="text-center mt-2">
                <span class="text-muted">Showing <span id="startIndex1L">1</span>-<span id="endIndex1L">10</span> of <span id="totalItems1L">0</span> stocks</span>
            </div>
        </div>
    </div>
    <!-- Trade Level Statistics -->
    <div class="d-flex align-items-center mb-2">
        <h3 class="me-3">Trade Level Statistics</h3>
        <button id="showProfitCharts" class="btn btn-success btn-sm me-2">Show all profit graphs</button>
        <button id="showLossCharts" class="btn btn-danger btn-sm">Show all loss stock graphs</button>
    </div>
    <div class="results-section mt-4">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="tradeTable1L">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>PNL</th>
                        <th>Entry Type</th>
                        <th>Entry Time</th>
                        <th>Exit Type</th>
                        <th>Exit Time</th>
                        <th>Gap Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in results.trade_stats %}
                    <tr>
                        <td class="trade-symbol-cell"
                            data-symbol="{{ trade.Symbol }}"
                            data-entry-time="{{ trade['Entry Time'] }}"
                            data-exit-time="{{ trade['Exit Time'] }}"
                            data-position="{{ trade.Position }}"
                            style="cursor:pointer; text-decoration:underline; color:#007bff;">
                            {{ trade.Symbol }}
                        </td>
                        <td class="{% if trade.PNL > 0 %}text-success{% elif trade.PNL < 0 %}text-danger{% endif %}">₹{{ trade.PNL|indian_currency }}</td>
                        <td>{{ trade['Entry Type'] }}</td>
                        <td>{{ trade['Entry Time'] }}</td>
                        <td>{{ trade['Exit Type'] }}</td>
                        <td>{{ trade['Exit Time'] }}</td>
                        <td>{{ trade['Gap Type'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Trade Chart Display -->
    <div id="tradeChartDiv" style="display:none; margin-top:30px; text-align:center;">
        <img id="tradeChartImg" src="" alt="Trade Chart" style="width:100vw; height:auto;">
    </div>
    <style>
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #f8f9fa;
        }
        .sort-icon {
            font-size: 0.8em;
            margin-left: 5px;
            color: #999;
        }
        .sort-asc .sort-icon::after {
            content: "↑";
        }
        .sort-desc .sort-icon::after {
            content: "↓";
        }
        .sort-asc .sort-icon, .sort-desc .sort-icon {
            color: #000;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const itemsPerPage = 10;
            let currentSortColumn = null;
            let isAscending = true;
            function initializeSorting() {
                const headers = document.querySelectorAll('.sortable');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.getAttribute('data-sort');
                        if (currentSortColumn === column) {
                            isAscending = !isAscending;
                        } else {
                            currentSortColumn = column;
                            isAscending = true;
                        }
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                        });
                        header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
                        sortTable(column, isAscending);
                    });
                });
            }
            function sortTable(column, ascending) {
                const tbody = document.querySelector('#stockTable1L tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const headers = document.querySelectorAll('#stockTable1L th');
                const columnIndex = Array.from(headers).findIndex(header => header.getAttribute('data-sort') === column);
                if (columnIndex === -1) return;
                rows.sort((a, b) => {
                    const aCell = a.querySelectorAll('td')[columnIndex];
                    const bCell = b.querySelectorAll('td')[columnIndex];
                    let aVal = aCell.getAttribute('data-value');
                    let bVal = bCell.getAttribute('data-value');
                    if (!isNaN(aVal) && !isNaN(bVal)) {
                        aVal = parseFloat(aVal);
                        bVal = parseFloat(bVal);
                    } else {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    if (aVal < bVal) return ascending ? -1 : 1;
                    if (aVal > bVal) return ascending ? 1 : -1;
                    return 0;
                });
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                rows.forEach(row => tbody.appendChild(row));
                showPage(1);
            }
            function initializePagination() {
                const rows = document.querySelectorAll('.stock-row-1L');
                const totalItems = rows.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                document.getElementById('totalItems1L').textContent = totalItems;
                const pagination = document.getElementById('pagination1L');
                pagination.innerHTML = '';
                const prevLi = document.createElement('li');
                prevLi.className = 'page-item';
                prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
                pagination.appendChild(prevLi);
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = 'page-item';
                    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pagination.appendChild(li);
                }
                const nextLi = document.createElement('li');
                nextLi.className = 'page-item';
                nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
                pagination.appendChild(nextLi);
                showPage(1);
                pagination.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (e.target.tagName === 'A') {
                        const pageText = e.target.textContent;
                        let newPage;
                        if (pageText === '«') {
                            const currentPage = getCurrentPage();
                            newPage = Math.max(1, currentPage - 1);
                        } else if (pageText === '»') {
                            const currentPage = getCurrentPage();
                            newPage = Math.min(totalPages, currentPage + 1);
                        } else {
                            newPage = parseInt(pageText);
                        }
                        showPage(newPage);
                    }
                });
            }
            function showPage(pageNumber) {
                const rows = document.querySelectorAll('.stock-row-1L');
                const startIndex = (pageNumber - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, rows.length);
                document.getElementById('startIndex1L').textContent = startIndex + 1;
                document.getElementById('endIndex1L').textContent = endIndex;
                rows.forEach(row => row.style.display = 'none');
                for (let i = startIndex; i < endIndex; i++) {
                    rows[i].style.display = '';
                }
                updateActivePage(pageNumber);
            }
            function updateActivePage(pageNumber) {
                const pagination = document.getElementById('pagination1L');
                const pages = pagination.getElementsByClassName('page-item');
                Array.from(pages).forEach(page => {
                    page.classList.remove('active');
                    const link = page.getElementsByClassName('page-link')[0];
                    if (link && link.textContent === pageNumber.toString()) {
                        page.classList.add('active');
                    }
                });
            }
            function getCurrentPage() {
                const pagination = document.getElementById('pagination1L');
                const activePage = pagination.querySelector('.active .page-link');
                return activePage ? parseInt(activePage.textContent) : 1;
            }
            initializePagination();
            initializeSorting();
            // Trade chart click handler
            document.querySelectorAll('.trade-symbol-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    const symbol = this.getAttribute('data-symbol');
                    const entryTime = this.getAttribute('data-entry-time');
                    const exitTime = this.getAttribute('data-exit-time');
                    const position = this.getAttribute('data-position');
                    fetch(`/gaps/trade_chart?symbol=${encodeURIComponent(symbol)}&entry_time=${encodeURIComponent(entryTime)}&exit_time=${encodeURIComponent(exitTime)}&position=${encodeURIComponent(position)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.image_url) {
                                document.getElementById('tradeChartImg').src = data.image_url;
                                document.getElementById('tradeChartDiv').style.display = 'block';
                            } else {
                                document.getElementById('tradeChartImg').src = '';
                                document.getElementById('tradeChartDiv').style.display = 'none';
                                alert('No chart available for this trade.');
                            }
                        });
                });
            });
            // Profit/Loss chart grid buttons
            document.getElementById('showProfitCharts').addEventListener('click', function() {
                window.open('/gaps/trade_charts_grid?filter=profit', '_blank');
            });
            document.getElementById('showLossCharts').addEventListener('click', function() {
                window.open('/gaps/trade_charts_grid?filter=loss', '_blank');
            });
        });
    </script>
    {% endif %}
{% endif %}
{% endblock %} 