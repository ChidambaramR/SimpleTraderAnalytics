{% extends "base.html" %}

{% macro price_cell(price, color_class, rowspan=None) %}
{% if rowspan %}
<td rowspan="{{ rowspan }}" class="bg-{{ color_class }}">{{ price }}</td>
{% else %}
<td class="bg-{{ color_class }}">{{ price }}</td>
{% endif %}
{% endmacro %}

{% block content %}
<div class="pre-market-container">
    <h1>Pre-Market Ticks Analysis</h1>

    <form method="POST" action="{{ url_for('analyze_pre_market_ticks') }}" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ date or request.form.get('date', '') }}" required>
            </div>
            <div class="col-md-4">
                <label for="symbol" class="form-label">Stock Symbol</label>
                <input type="text" class="form-control" id="symbol" name="symbol" 
                       value="{{ symbol or request.form.get('symbol', '') }}" 
                       placeholder="e.g., BATAINDIA" required>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Analyze</button>
            </div>
        </div>
    </form>

    {% if date and symbol and df is none %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('form').submit();
    });
    </script>
    {% endif %}

    {% if df is defined and df is not none %}
    <div class="results-section mt-4">
        <h2>Summary</h2>
        <div class="table-responsive mb-4">
            <table class="table table-striped table-bordered pre-market-table">
                <thead>
                    <tr>
                        <th>Last Price</th>
                        <th>Last Traded Quantity</th>
                        <th>Average Traded Price</th>
                        <th>Last Trade Time</th>
                        <th>High</th>
                        <th>Low</th>
                        <th>Close</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ summary.last_price }}</td>
                        <td>{{ summary.last_traded_quantity }}</td>
                        <td>{{ summary.average_traded_price }}</td>
                        <td>{{ summary.last_trade_time }}</td>
                        <td>{{ summary.high }}</td>
                        <td>{{ summary.low }}</td>
                        <td>{{ summary.close }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>Market Depth Analysis</h2>
        <div class="table-responsive mb-4">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Equilibrium Price</th>
                        <th>Price</th>
                        <th>Buy Orders</th>
                        <th>Buy Quantity</th>
                        <th>Cumulative Buy Qty</th>
                        <th>Sell Orders</th>
                        <th>Sell Quantity</th>
                        <th>Cumulative Sell Qty</th>
                    </tr>
                </thead>
                <tbody>
                    {% for index, row in df.iterrows() %}
                    {% set depth_data = prepare_depth_data(row) %}
                    {% for _, depth_row in depth_data.iterrows() %}
                    <tr>
                        {% if loop.first %}
                        <td rowspan="{{ depth_data|length }}">{{ row.ts.strftime("%H:%M:%S") }}</td>
                        {{ price_cell(row.open, row.open_color, rowspan=depth_data|length) }}
                        {% endif %}
                        <td>{{ depth_row.price }}</td>
                        <td>{{ depth_row.buy_orders }}</td>
                        <td>{{ depth_row.buy_quantity }}</td>
                        <td>{{ depth_row.cumulative_buy_quantity }}</td>
                        <td>{{ depth_row.sell_orders }}</td>
                        <td>{{ depth_row.sell_quantity }}</td>
                        <td>{{ depth_row.cumulative_sell_quantity }}</td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 