{% extends "base.html" %}

{% block content %}
<div class="pre-market-container">
    <h1>Pre-Market Ticks Analysis</h1>

    <form method="POST" action="{{ url_for('analyze_pre_market_ticks') }}" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ date or request.form.get('date', '') }}" required>
            </div>
            <div class="col-md-4">
                <label for="symbol" class="form-label">Stock Symbol</label>
                <input type="text" class="form-control" id="symbol" name="symbol" 
                       value="{{ symbol or request.form.get('symbol', '') }}" 
                       placeholder="e.g., BATAINDIA" required>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Analyze</button>
            </div>
        </div>
    </form>

    <!-- Add this right after the form -->
    {% if date and symbol and df is none %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit the form if we have date and symbol but no results yet
        document.querySelector('form').submit();
    });
    </script>
    {% endif %}

    {% if df is defined and df is not none %}
    <div class="results-section mt-4">
        <h2>Summary</h2>
        <div class="table-responsive mb-4">
            <table class="table table-striped table-bordered pre-market-table">
                <thead>
                    <tr>
                        <th>Last Price</th>
                        <th>Last Traded Quantity</th>
                        <th>Average Traded Price</th>
                        <th>Last Trade Time</th>
                        <th>High</th>
                        <th>Low</th>
                        <th>Close</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ summary.last_price }}</td>
                        <td>{{ summary.last_traded_quantity }}</td>
                        <td>{{ summary.average_traded_price }}</td>
                        <td>{{ summary.last_trade_time }}</td>
                        <td>{{ summary.high }}</td>
                        <td>{{ summary.low }}</td>
                        <td>{{ summary.close }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="chart-section mb-4">
            <div class="mb-4">
                <h2>Open Price Trend</h2>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="openPriceChart"></canvas>
                </div>
            </div>
            <div class="mb-4">
                <h2>Buy Depth</h2>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="buyDepthChart"></canvas>
                </div>
            </div>
            <div class="mb-4">
                <h2>Sell Depth</h2>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="sellDepthChart"></canvas>
                </div>
            </div>
        </div>

        <h2>Pre-Market Ticks Data</h2>
        <div class="table-responsive">
            <table class="table table-striped table-bordered pre-market-table">
                <thead>
                    <tr>
                        {% for column in df.columns %}
                        {% if column != 'open_color' %}  {# Skip open_color column #}
                        <th>
                            {% if column == 'ts' %}
                                Timestamp
                            {% elif column == 'volume_traded' %}
                                Volume
                            {% elif column == 'total_buy_quantity' %}
                                BuyQty
                            {% elif column == 'total_sell_quantity' %}
                                SellQty
                            {% else %}
                                {{ column }}
                            {% endif %}
                        </th>
                        {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for index, row in df.iterrows() %}
                    <tr>
                        {% for column in df.columns %}
                        <td {% if column == 'ts' %}style="min-width: 150px;"{% endif %}
                            {% if column == 'open' %}
                                class="bg-{{ row['open_color'] }}"
                            {% endif %}>
                            {% if column.startswith('buy_depth_') or column.startswith('sell_depth_') %}
                                {% if row[column] %}
                                    {{ row[column]['orders'] }} : {{ row[column]['price'] }} : {{ row[column]['quantity'] }}
                                {% else %}
                                    -
                                {% endif %}
                            {% elif column != 'open_color' %}  {# Don't display the color column #}
                                {{ row[column] }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

{% if df is defined and df is not none %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Time labels for all charts
    const timeLabels = [{% for index, row in df.iterrows() %}
        '{{ row.ts.strftime("%H:%M:%S") }}',
    {% endfor %}];

    // Open Price Chart
    new Chart(
        document.getElementById('openPriceChart'),
        {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Open Price',
                    data: [{% for index, row in df.iterrows() %}
                        {{ row.open }},
                    {% endfor %}],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    pointRadius: 0  // Remove points
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Open Price vs Time'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        }
    );

    // Buy Depth Chart
    new Chart(
        document.getElementById('buyDepthChart'),
        {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {% for i in range(1, 6) %}
                    {
                        label: 'Level {{ i }}',
                        data: [{% for index, row in df.iterrows() %}
                            {{ row['buy_depth_' ~ i]['quantity'] if row['buy_depth_' ~ i] else 0 }},
                        {% endfor %}],
                        borderColor: '{{ ["#2E8B57", "#3CB371", "#90EE90", "#98FB98", "#E0FFF0"][i-1] }}',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0  // Remove points
                    },
                    {% endfor %}
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Buy Depth Over Time'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    }
                }
            }
        }
    );

    // Sell Depth Chart
    new Chart(
        document.getElementById('sellDepthChart'),
        {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {% for i in range(1, 6) %}
                    {
                        label: 'Level {{ i }}',
                        data: [{% for index, row in df.iterrows() %}
                            {{ row['sell_depth_' ~ i]['quantity'] if row['sell_depth_' ~ i] else 0 }},
                        {% endfor %}],
                        borderColor: '{{ ["#8B0000", "#DC143C", "#FF4500", "#FF6347", "#FFA07A"][i-1] }}',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0  // Remove points
                    },
                    {% endfor %}
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Sell Depth Over Time'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    }
                }
            }
        }
    );
});
</script>
{% endif %}
{% endblock %} 